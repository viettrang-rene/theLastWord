<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Puzzle Fun Generator</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter font from Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Poppins font from Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;300;800&display=swap" rel="stylesheet">
    <!-- PDF-LIB for PDF generation -->
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <style>
        /* General Body and App Container Styling */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f8f8;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 2rem;
            box-sizing: border-box;
        }
        .container {
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            padding: 2.5rem;
            width: 100%;
            max-width: 900px;
            display: flex;
            flex-direction: column;
            gap: 2rem;
            transition: border-color 0.3s ease-in-out;
            border: 2px solid transparent;
        }
        .theme-button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: none;
            color: white;
        }
        .theme-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
        }
        .theme-easy-animals { background-color: #4CAF50; }
        .theme-farm-animals { background-color: #8B4513; }
        .theme-ocean-animals { background-color: #2196F3; }

        .generate-button {
            background-color: #4F46E5;
            color: white;
            padding: 1rem 2rem;
            border-radius: 0.75rem;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, transform 0.2s ease-in-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .generate-button:hover {
            background-color: #4338CA;
            transform: translateY(-2px);
        }
        .generate-button:disabled {
            background-color: #9CA3AF;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        textarea {
            min-height: 150px;
            border-radius: 0.75rem;
            padding: 1rem;
            border: 2px solid #D1D5DB;
            transition: border-color 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            resize: vertical;
        }
        textarea:focus {
            outline: none;
            border-color: #4F46E5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
        }
        .error-message {
            color: #EF4444;
            font-weight: 600;
            margin-top: 0.5rem;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            flex-direction: column;
            gap: 1rem;
            font-size: 1.2rem;
            font-weight: 600;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4F46E5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Puzzle Specific Styles */
        .game-container, .word-search-container, .puzzle-grid, .clues {
            font-family: 'Poppins', sans-serif;
        }

        .game-container {
            padding: 10px;
            display: flex;
            width: 100%;
            justify-content: space-around;
            min-height: 100vh;
            align-items: flex-start;
            flex-wrap: wrap;
            gap: 20px;
        }

        .puzzle-grid {
            display: grid;
            box-shadow: rgba(17, 12, 46, 0.15) 0px 48px 100px 0px;
            background-color: white;
            border-radius: 0.5rem;
            overflow: hidden;
        }

        .puzzle-grid .row {
            display: grid;
        }

        .puzzle-grid .cell {
            width: 40px;
            height: 40px;
            background-color: white;
            border: 1px solid green;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        .puzzle-grid .inactive {
            background-color: green;
        }

        .puzzle-grid h1 {
            text-align: center;
            color: green;
            font-size: 2.2rem;
            position: absolute;
            top: 2px;
            width: 100%;
        }

        .puzzle-grid .number {
            position: absolute;
            font-weight: 300;
            color: #000;
            top: 2px;
            left: 3px;
            font-size: small;
            z-index: 10;
        }

        .puzzle-grid input {
            display: block;
            position: relative;
            font-size: 16px;
            text-align: center;
            height: 100%;
            width: 100%;
            background-color: transparent;
            border: none;
            z-index: 1;
            padding: 0;
            margin: 0;
            box-sizing: border-box;
        }

        .puzzle-grid input:focus {
            outline: none;
            background-color: #bddebe;
        }

        .clues {
            flex: 1;
            min-width: 300px;
            max-width: 40%;
            padding: 10px;
            background-color: #ffffff;
            border-radius: 0.5rem;
            box-shadow: rgba(17, 12, 46, 0.15) 0px 48px 100px 0px;
        }

        .clues h2 {
            font-size: 1.5rem;
            color: green;
            text-align: center;
            margin-bottom: 15px;
        }

        .clues table {
            font-family: 'Poppins', sans-serif;
            border-collapse: collapse;
            width: 100%;
        }

        .clues td, .clues th {
            border: 1px solid #dddddd;
            text-align: left;
            padding: 8px;
        }

        .clues tr:nth-child(even) {
            background-color: #dddddd;
        }
        .clues button {
            background-color: green;
            color: #fff;
            border-radius: 5px;
            font-family: 'Poppins', sans-serif;
            border: 2px solid transparent;
            padding: 5px 10px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all .2s ease;
        }
        .clues button:hover {
            background-color: #fff;
            border: 2px solid green;
            color: green;
        }
        .clues .answer-text {
            visibility: hidden;
            color: green;
            display: inline-block;
            margin-left: 10px;
        }
        .clues button:hover + .answer-text {
            visibility: visible;
        }

        /* Word Search Styles */
        .word-search-container {
            margin: 30px auto;
            flex: 1;
            min-width: 300px;
            background-color: #ffffff;
            border-radius: 0.5rem;
            box-shadow: rgba(17, 12, 46, 0.15) 0px 48px 100px 0px;
            padding: 15px;
        }
        .word-search {
            border: 2px solid #4a89dc;
            border-collapse: collapse;
            margin: 0 auto;
            background-color: #e6f2ff;
            border-radius: 8px;
            overflow: hidden;
        }
        .word-search td {
            width: 30px;
            height: 30px;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            border: 1px solid #b3d1ff;
            background-color: #e6f2ff;
            color: #2c3e50;
            cursor: pointer;
            user-select: none;
            transition: all 0.3s ease;
        }
        .word-search td:hover {
            background-color: #cce0ff;
        }
        .word-search td.found-word {
            background-color: #ffebee !important;
            color: #c62828 !important;
            border-color: #ef9a9a !important;
        }
        .word-list {
            margin: 20px 0;
            padding: 15px;
            background-color: #e6f2ff;
            border-radius: 8px;
            border: 1px solid #b3d1ff;
        }
        .word-list h3 {
            margin-top: 0;
            color: #2c3e50;
        }
        .word-list ul {
            list-style-type: none;
            padding: 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
        }
        .word-list li {
            font-size: 18px;
            font-weight: bold;
            padding: 8px 15px;
            border-radius: 6px;
            background-color: #d9e6ff;
            color: #2c3e50;
        }
        .word-list li.found {
            background-color: #ffebee;
            color: #c62828;
            position: relative;
        }
        .word-list li.found::after {
            content: "";
            position: absolute;
            left: 10%;
            top: 50%;
            width: 80%;
            height: 2px;
            background-color: #c62828;
            transform: translateY(-50%);
        }
        .highlight {
            background-color: #fff3e0;
        }
        .stats {
            margin: 20px 0;
            font-size: 18px;
            background-color: #e6f2ff;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #b3d1ff;
        }
        .congrats {
            color: #c62828;
            font-weight: bold;
            font-size: 20px;
            margin: 20px 0;
            padding: 15px;
            background-color: #ffebee;
            border-radius: 8px;
            display: none;
        }

        /* Simple Crossword Grid */
        .simple-crossword {
            display: grid;
            gap: 1px;
            margin: 20px auto;
        }
        .simple-crossword-cell {
            width: 40px;
            height: 40px;
            border: 1px solid #000;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            background-color: white;
        }
        .simple-crossword-black {
            background-color: #000;
        }

        /* Responsive Styles */
        @media screen and (max-width: 980px) {
            .game-container {
                flex-direction: column;
                align-items: center;
                padding-top: 70px;
                gap: 30px;
            }
            .puzzle-grid, .word-search-container, .clues {
                max-width: 100%;
                width: 100%;
            }
            .puzzle-grid .cell, .word-search td {
                width: 35px;
                height: 35px;
            }
            .puzzle-grid input {
                font-size: 0.9rem;
            }
            .puzzle-grid .number {
                font-size: 0.7rem;
            }
            .word-search td {
                font-size: 18px;
            }
        }

        @media screen and (max-width: 480px) {
            .puzzle-grid .cell, .word-search td {
                width: 27px;
                height: 27px;
            }
            .puzzle-grid input {
                font-size: 0.7rem;
            }
            .puzzle-grid .number {
                font-size: 0.5rem;
                top: 1px;
                left: 2px;
            }
            .word-search td {
                font-size: 16px;
            }
            .clues button {
                padding: 3px 8px;
                font-size: 0.75rem;
            }
            .clues td, .clues th {
                padding: 5px;
            }
            .word-list li {
                font-size: 16px;
                padding: 6px 10px;
            }
            .stats {
                font-size: 16px;
                padding: 10px;
            }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <div id="input-section" class="container">
        <h1 class="text-4xl font-extrabold text-center text-gray-900 mb-4">2Puzzle Fun Generator!</h1>
        <p class="text-md text-center text-gray-600 mb-8">Create custom crossword and word search puzzles.</p>

        <div class="flex flex-col md:flex-row gap-4 mb-6">
            <div class="flex-1">
                <label for="wordInput" class="block text-lg font-semibold text-gray-700 mb-2">Enter your words:</label>
                <textarea
                    id="wordInput"
                    class="w-full focus:ring-indigo-500 focus:border-indigo-500"
                    placeholder="Enter words (e.g., apple, banana, dolphin) or pick a theme below."
                ></textarea>
                <p id="errorMessage" class="error-message hidden">Only letters allowed. Please try again!</p>
            </div>
            <div class="md:w-1/3 flex flex-col gap-3">
                <label class="block text-lg font-semibold text-gray-700 mb-2">Or choose a theme:</label>
                <button id="easyAnimalsBtn" class="theme-button theme-easy-animals">Easy Animals</button>
                <button id="farmAnimalsBtn" class="theme-button theme-farm-animals">Farm Animals</button>
                <button id="oceanAnimalsBtn" class="theme-button theme-ocean-animals">Ocean Animals</button>
                <button id="resetBtn" class="generate-button bg-gray-500 hover:bg-gray-600 mt-4">Reset</button>
            </div>
        </div>

        <button id="generatePuzzlesBtn" class="generate-button w-full">Generate Puzzles</button>
    </div>

    <div id="puzzles-section" class="container hidden">
        <h1 class="text-4xl font-extrabold text-center text-gray-900 mb-4">Your Puzzles!</h1>
        <p class="text-md text-center text-gray-600 mb-8">Interact with them below or print to PDF.</p>

        <div class="game-container">
            <!-- Simple Crossword Puzzle -->
            <div id="simple-crossword-wrapper" class="flex flex-col items-center flex-1 min-w-[300px]">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Crossword Puzzle</h2>
                <div id="simple-crossword-grid" class="simple-crossword">
                    <!-- Simple crossword grid will be inserted here -->
                </div>
                <div id="simple-crossword-clues" class="clues mt-4">
                    <h2>Clues</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Clue</th>
                                <th>Answer</th>
                            </tr>
                        </thead>
                        <tbody id="simple-crossword-clues-body">
                            <!-- Clues will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Word Search Puzzle -->
            <div id="interactive-wordsearch-wrapper" class="flex flex-col items-center flex-1 min-w-[300px]">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Word Search Puzzle</h2>
                <div class="stats hidden">
                    Found: <span id="found-count">0</span> of <span id="total-words">0</span> words
                </div>
                <div class="congrats" id="congrats-message">
                    Congratulations! You found all the words!
                </div>
                <div class="word-list hidden">
                    <h3>Words to find:</h3>
                    <ul id="words-to-find"></ul>
                </div>
                <div class="word-search-container">
                    <table class="word-search" id="wordSearch"></table>
                </div>
            </div>
        </div>

        <button id="printPdfBtn" class="generate-button w-full mt-8">Print to PDF</button>
        <button id="backToInputBtn" class="generate-button bg-gray-500 hover:bg-gray-600 w-full mt-4">Back to Input</button>
    </div>

    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="spinner"></div>
        <p>Generating your puzzles...</p>
        <p class="text-sm text-gray-500">This might take a moment as we create the puzzles.</p>
    </div>

    <script>
        const { PDFDocument, rgb, StandardFonts } = PDFLib;

        // UI Elements
        const wordInput = document.getElementById('wordInput');
        const errorMessage = document.getElementById('errorMessage');
        const easyAnimalsBtn = document.getElementById('easyAnimalsBtn');
        const farmAnimalsBtn = document.getElementById('farmAnimalsBtn');
        const oceanAnimalsBtn = document.getElementById('oceanAnimalsBtn');
        const resetBtn = document.getElementById('resetBtn');
        const generatePuzzlesBtn = document.getElementById('generatePuzzlesBtn');
        const printPdfBtn = document.getElementById('printPdfBtn');
        const backToInputBtn = document.getElementById('backToInputBtn');
        const appContainer = document.getElementById('input-section');
        const puzzlesSection = document.getElementById('puzzles-section');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const simpleCrosswordGrid = document.getElementById('simple-crossword-grid');
        const simpleCrosswordCluesBody = document.getElementById('simple-crossword-clues-body');
        const wordSearchTable = document.getElementById('wordSearch');
        const wordsToFindList = document.getElementById('words-to-find');
        const foundCountSpan = document.getElementById('found-count');
        const totalWordsSpan = document.getElementById('total-words');
        const congratsMessage = document.getElementById('congrats-message');
        const statsDiv = document.querySelector('#puzzles-section .stats');
        const wordListDiv = document.querySelector('#puzzles-section .word-list');

        // Theme Colors
        const themeColors = {
            'easyAnimals': { ui: '#4CAF50', pdf: rgb(0.29, 0.69, 0.29) },
            'farmAnimals': { ui: '#8B4513', pdf: rgb(0.55, 0.27, 0.07) },
            'oceanAnimals': { ui: '#2196F3', pdf: rgb(0.13, 0.59, 0.95) }
        };
        let currentThemeColor = null;

        // Pre-defined Themes
        const themes = {
            'easyAnimals': ['cat', 'dog', 'bird', 'fish', 'bear', 'lion', 'zebra', 'mouse'],
            'farmAnimals': ['cow', 'pig', 'chicken', 'sheep', 'horse', 'goat', 'duck', 'barn'],
            'oceanAnimals': ['dolphin', 'whale', 'shark', 'octopus', 'crab', 'jellyfish', 'seahorse', 'starfish']
        };

        // Puzzle Data Storage
        let activeWordsForPuzzles = [];
        let wordSearchGrid = [];
        let wordSearchWordPositions = {};
        let foundWords = new Set();
        let wordSearchGridSize = 15;

        // Helper Functions
        function scrambleWord(word) {
            if (word.length <= 1) return word;
            const a = word.split("");
            let n = a.length;
            for (let i = n - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                const temp = a[i];
                a[i] = a[j];
                a[j] = temp;
            }
            return a.join("");
        }

        function validateInput(input) {
            const words = input.split(/[\n,]+/).map(word => word.trim()).filter(word => word.length > 0);
            for (const word of words) {
                if (!/^[a-zA-Z]+$/.test(word)) {
                    return false;
                }
            }
            return true;
        }

        function applyThemeStyling(themeName) {
            currentThemeColor = themeColors[themeName];
            if (currentThemeColor) {
                appContainer.style.borderColor = currentThemeColor.ui;
                generatePuzzlesBtn.style.backgroundColor = currentThemeColor.ui;
                wordInput.style.borderColor = currentThemeColor.ui;
                wordInput.style.boxShadow = `0 0 0 3px ${currentThemeColor.ui}33`;
            }
        }

        function resetApp() {
            wordInput.value = '';
            errorMessage.classList.add('hidden');
            appContainer.style.borderColor = 'transparent';
            generatePuzzlesBtn.style.backgroundColor = '#4F46E5';
            wordInput.style.borderColor = '#D1D5DB';
            wordInput.style.boxShadow = 'none';
            currentThemeColor = null;
            activeWordsForPuzzles = [];
            puzzlesSection.classList.add('hidden');
            appContainer.classList.remove('hidden');
        }

        function getRandomChar() {
            const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
            return alphabet.charAt(Math.floor(Math.random() * alphabet.length));
        }

        // Simple Crossword Generation
        function generateSimpleCrossword(words) {
            simpleCrosswordGrid.innerHTML = '';
            simpleCrosswordCluesBody.innerHTML = '';
            
            // Create a simple grid with one word per row
            const gridSize = Math.max(...words.map(word => word.length)) + 2;
            const grid = Array(gridSize).fill().map(() => Array(gridSize).fill(''));
            
            // Place each word in its own row
            words.forEach((word, wordIndex) => {
                const row = wordIndex * 2 + 1; // Leave space between words
                for (let col = 0; col < word.length; col++) {
                    grid[row][col + 1] = word[col].toUpperCase();
                }
            });
            
            // Create the grid HTML
            simpleCrosswordGrid.style.gridTemplateColumns = `repeat(${gridSize}, 40px)`;
            simpleCrosswordGrid.style.gridTemplateRows = `repeat(${gridSize}, 40px)`;
            
            for (let row = 0; row < gridSize; row++) {
                for (let col = 0; col < gridSize; col++) {
                    const cell = document.createElement('div');
                    cell.className = 'simple-crossword-cell';
                    
                    if (grid[row][col] === '') {
                        cell.classList.add('simple-crossword-black');
                    } else {
                        cell.textContent = grid[row][col];
                        // Add number if it's the start of a word
                        if (col === 0 || grid[row][col - 1] === '') {
                            const number = document.createElement('span');
                            number.className = 'number';
                            number.textContent = row + 1;
                            cell.appendChild(number);
                        }
                    }
                    simpleCrosswordGrid.appendChild(cell);
                }
            }
            
            // Add clues
            words.forEach((word, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${scrambleWord(word.toLowerCase())} (${word.length} letters)</td>
                    <td>
                        <button class="show-answer-btn" data-answer="${word}">Show Answer</button>
                        <span class="answer-text">${word}</span>
                    </td>
                `;
                simpleCrosswordCluesBody.appendChild(tr);
            });
            
            // Add event listeners for show answer buttons
            document.querySelectorAll('.show-answer-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const answerText = e.target.nextElementSibling;
                    if (answerText) {
                        answerText.style.visibility = 'visible';
                    }
                });
            });
        }

        // Word Search Generation
        const directions = [
            [1, 0], [0, 1], [1, 1], [-1, 1],
            [-1, 0], [0, -1], [-1, -1], [1, -1]
        ];

        function canPlaceWord(word, row, col, direction) {
            const [rowDir, colDir] = direction;
            const endRow = row + (word.length - 1) * rowDir;
            const endCol = col + (word.length - 1) * colDir;

            if (endRow < 0 || endRow >= wordSearchGridSize || endCol < 0 || endCol >= wordSearchGridSize) {
                return false;
            }

            for (let i = 0; i < word.length; i++) {
                const r = row + i * rowDir;
                const c = col + i * colDir;

                if (wordSearchGrid[r][c] !== '' && wordSearchGrid[r][c] !== word[i]) {
                    return false;
                }
            }
            return true;
        }

        function placeWord(word) {
            let placed = false;
            let attempts = 0;

            while (!placed && attempts < 100) {
                attempts++;
                const direction = directions[Math.floor(Math.random() * directions.length)];
                const [rowDir, colDir] = direction;

                let row, col;

                if (rowDir === 1) {
                    row = Math.floor(Math.random() * (wordSearchGridSize - word.length));
                } else if (rowDir === -1) {
                    row = Math.floor(Math.random() * (wordSearchGridSize - word.length)) + word.length - 1;
                } else {
                    row = Math.floor(Math.random() * wordSearchGridSize);
                }

                if (colDir === 1) {
                    col = Math.floor(Math.random() * (wordSearchGridSize - word.length));
                } else if (colDir === -1) {
                    col = Math.floor(Math.random() * (wordSearchGridSize - word.length)) + word.length - 1;
                } else {
                    col = Math.floor(Math.random() * wordSearchGridSize);
                }

                if (canPlaceWord(word, row, col, direction)) {
                    wordSearchWordPositions[word] = {
                        start: {row, col},
                        direction: [rowDir, colDir],
                        letters: []
                    };

                    for (let i = 0; i < word.length; i++) {
                        const r = row + i * rowDir;
                        const c = col + i * colDir;
                        wordSearchGrid[r][c] = word[i];
                        wordSearchWordPositions[word].letters.push({row: r, col: c});
                    }
                    placed = true;
                }
            }
            return placed;
        }

        function fillEmptySpaces() {
            for (let i = 0; i < wordSearchGridSize; i++) {
                for (let j = 0; j < wordSearchGridSize; j++) {
                    if (wordSearchGrid[i][j] === '') {
                        wordSearchGrid[i][j] = getRandomChar();
                    }
                }
            }
        }

        function renderWordSearchGrid() {
            wordSearchTable.innerHTML = '';

            for (let i = 0; i < wordSearchGridSize; i++) {
                const row = document.createElement('tr');

                for (let j = 0; j < wordSearchGridSize; j++) {
                    const cell = document.createElement('td');
                    cell.textContent = wordSearchGrid[i][j];
                    cell.dataset.row = i;
                    cell.dataset.col = j;
                    row.appendChild(cell);
                }
                wordSearchTable.appendChild(row);
            }
            addCellClickListeners();
        }

        function addCellClickListeners() {
            const cells = document.querySelectorAll('#wordSearch td');
            cells.forEach(cell => {
                cell.removeEventListener('click', handleCellClick);
                cell.addEventListener('click', handleCellClick);
            });
        }

        function handleCellClick(event) {
            const cell = event.target;
            const row = parseInt(cell.dataset.row);
            const col = parseInt(cell.dataset.col);

            for (const word in wordSearchWordPositions) {
                const positions = wordSearchWordPositions[word].letters;
                const isPartOfWord = positions.some(pos => pos.row === row && pos.col === col);

                if (isPartOfWord && !foundWords.has(word)) {
                    highlightWord(word);
                    foundWords.add(word);
                    markWordAsFound(word);
                    updateFoundCount();
                    return;
                }
            }

            cell.classList.add('highlight');
            setTimeout(() => {
                cell.classList.remove('highlight');
            }, 500);
        }

        function highlightWord(word) {
            const positions = wordSearchWordPositions[word].letters;
            positions.forEach(pos => {
                const cell = document.querySelector(`#wordSearch td[data-row="${pos.row}"][data-col="${pos.col}"]`);
                if (cell) {
                    cell.classList.add('found-word');
                }
            });
        }

        function markWordAsFound(word) {
            const wordElement = document.querySelector(`#words-to-find li[data-word="${word}"]`);
            if (wordElement) {
                wordElement.classList.add('found');
            }
        }

        function updateFoundCount() {
            foundCountSpan.textContent = foundWords.size;
            totalWordsSpan.textContent = activeWordsForPuzzles.length;

            if (foundWords.size === activeWordsForPuzzles.length && activeWordsForPuzzles.length > 0) {
                congratsMessage.style.display = 'block';
            } else {
                congratsMessage.style.display = 'none';
            }
        }

        function initializeWordSearch() {
            wordSearchGrid = [];
            wordSearchWordPositions = {};
            foundWords.clear();
            updateFoundCount();
            congratsMessage.style.display = 'none';

            for (let i = 0; i < wordSearchGridSize; i++) {
                wordSearchGrid[i] = [];
                for (let j = 0; j < wordSearchGridSize; j++) {
                    wordSearchGrid[i][j] = '';
                }
            }

            wordsToFindList.innerHTML = '';
            activeWordsForPuzzles.forEach(word => {
                const li = document.createElement('li');
                li.textContent = word;
                li.dataset.word = word;
                wordsToFindList.appendChild(li);
            });

            const cells = document.querySelectorAll('#wordSearch td');
            cells.forEach(cell => {
                cell.classList.remove('found-word');
            });
        }

        function generateWordSearch() {
            wordSearchGridSize = Math.max(12, Math.ceil(Math.sqrt(activeWordsForPuzzles.join('').length)) + 3;
            initializeWordSearch();

            const wordsForWS = [...activeWordsForPuzzles].sort((a, b) => b.length - a.length);

            let allPlaced = true;
            wordsForWS.forEach(word => {
                if (!placeWord(word)) {
                    console.warn(`Could not place word in word search: ${word}`);
                    allPlaced = false;
                }
            });

            if (!allPlaced) {
                console.warn("Some words couldn't be placed in the word search. Try with fewer or shorter words.");
            }

            fillEmptySpaces();
            renderWordSearchGrid();

            statsDiv.style.display = 'block';
            wordListDiv.style.display = 'block';
        }

        // PDF Generation
        async function generatePdf() {
            const pdfDoc = await PDFDocument.create();
            const margin = 30;
            const { width, height } = { width: 595.28, height: 841.89 };
            const contentWidth = width - 2 * margin;

            const font = await pdfDoc.embedFont(StandardFonts.Helvetica);
            const boldFont = await pdfDoc.embedFont(StandardFonts.HelveticaBold);
            const accentColor = currentThemeColor ? currentThemeColor.pdf : rgb(0.8, 0.8, 0.8);

            function drawPageBorderAndHeader(page, pageNum) {
                page.drawRectangle({
                    x: margin / 2,
                    y: margin / 2,
                    width: width - margin,
                    height: height - margin,
                    borderColor: accentColor,
                    borderWidth: 5,
                    opacity: 0.8,
                    borderOpacity: 0.8,
                    lineCap: 'round',
                    lineJoin: 'round',
                    dashArray: [5, 5],
                });

                let currentY = height - margin;

                const headerTitleSize = 36;
                const headerSubtitleSize = 14;
                const studentNameLineSize = 12;
                const headerSpacing = 20;

                page.drawText('Puzzle Fun!', {
                    x: margin,
                    y: currentY - headerTitleSize,
                    font: boldFont,
                    size: headerTitleSize,
                    color: rgb(0, 0, 0),
                });
                currentY -= headerTitleSize + headerSpacing;

                page.drawText('Made by Rene', {
                    x: margin,
                    y: currentY - headerSubtitleSize,
                    font: font,
                    size: headerSubtitleSize,
                    color: rgb(0.3, 0.3, 0.3),
                });
                currentY -= headerSubtitleSize + headerSpacing;

                page.drawText('Student name: _________________', {
                    x: margin,
                    y: currentY - studentNameLineSize,
                    font: font,
                    size: studentNameLineSize,
                    color: rgb(0, 0, 0),
                });
                currentY -= studentNameLineSize + 40;

                if (pageNum > 1) {
                    page.drawText(`Page ${pageNum}`, { x: width - margin - 50, y: height - margin + 10, font: font, size: 8 });
                }

                return currentY;
            }

            let page1 = pdfDoc.addPage();
            let currentY = drawPageBorderAndHeader(page1, 1);
            let currentPage = page1;

            // Simple Crossword in PDF
            const crosswordTitleSize = 20;
            const crosswordTitleMarginBottom = 15;

            currentPage.drawText('Crossword Puzzle', {
                x: margin,
                y: currentY - crosswordTitleSize,
                font: boldFont,
                size: crosswordTitleSize,
                color: rgb(0, 0, 0),
            });
            currentY -= crosswordTitleSize + crosswordTitleMarginBottom;

            // Calculate grid size for PDF
            const maxWordLength = Math.max(...activeWordsForPuzzles.map(word => word.length));
            const gridRows = activeWordsForPuzzles.length * 2 + 1;
            const gridCols = maxWordLength + 2;
            const cellSize = Math.min(15, (contentWidth - 20) / gridCols);

            // Draw crossword grid
            for (let row = 0; row < gridRows; row++) {
                for (let col = 0; col < gridCols; col++) {
                    const x = margin + col * cellSize;
                    const y = currentY - (row + 1) * cellSize;

                    // Determine if this is a word cell or black cell
                    const wordIndex = Math.floor(row / 2);
                    const isWordRow = row % 2 === 1;
                    const isWordCell = isWordRow && col > 0 && col <= activeWordsForPuzzles[wordIndex]?.length;

                    if (isWordCell) {
                        currentPage.drawRectangle({
                            x: x, y: y, width: cellSize, height: cellSize,
                            borderColor: rgb(0, 0, 0),
                            borderWidth: 0.5,
                        });
                        // Add number if first cell of word
                        if (col === 1) {
                            currentPage.drawText((wordIndex + 1).toString(), {
                                x: x + 2,
                                y: y + cellSize - 4,
                                font: font,
                                size: 8,
                                color: rgb(0, 0, 0),
                            });
                        }
                    } else {
                        currentPage.drawRectangle({
                            x: x, y: y, width: cellSize, height: cellSize,
                            borderColor: rgb(0, 0, 0),
                            borderWidth: 0.5,
                            color: rgb(0, 0, 0),
                        });
                    }
                }
            }
            currentY -= gridRows * cellSize + 20;

            // Add clues
            currentPage.drawText('Clues:', {
                x: margin,
                y: currentY,
                font: boldFont,
                size: 14,
                color: rgb(0, 0, 0),
            });
            currentY -= 20;

            const cluesPerColumn = Math.floor((currentY - margin) / 15);
            const columnWidth = 90;
            let column = 0;

            activeWordsForPuzzles.forEach((word, index) => {
                if (currentY < margin + 20) {
                    currentPage = pdfDoc.addPage();
                    currentY = drawPageBorderAndHeader(currentPage, pdfDoc.getPageCount());
                    column = 0;
                }

                if (index > 0 && index % cluesPerColumn === 0) {
                    column++;
                    currentY = height - margin - 60;
                }

                currentPage.drawText(`${index + 1}. ${scrambleWord(word.toLowerCase())} (${word.length} letters)`, {
                    x: margin + column * columnWidth,
                    y: currentY,
                    font: font,
                    size: 12,
                    color: rgb(0, 0, 0),
                });
                currentY -= 15;
            });

            // Word Search in PDF
            currentPage = pdfDoc.addPage();
            currentY = drawPageBorderAndHeader(currentPage, pdfDoc.getPageCount());

            const wordSearchTitleSize = 20;
            currentPage.drawText('Word Search Puzzle', {
                x: margin,
                y: currentY - wordSearchTitleSize,
                font: boldFont,
                size: wordSearchTitleSize,
                color: rgb(0, 0, 0),
            });
            currentY -= wordSearchTitleSize + 20;

            // Calculate word search grid size for PDF
            const wsCellSize = Math.min(15, (contentWidth - 20) / wordSearchGridSize);
            const wsGridStartX = margin;
            const wsGridStartY = currentY - wordSearchGridSize * wsCellSize - 10;

            // Draw word search grid
            for (let row = 0; row < wordSearchGridSize; row++) {
                for (let col = 0; col < wordSearchGridSize; col++) {
                    const x = wsGridStartX + col * wsCellSize;
                    const y = wsGridStartY + (wordSearchGridSize - 1 - row) * wsCellSize;

                    currentPage.drawRectangle({
                        x: x, y: y, width: wsCellSize, height: wsCellSize,
                        borderColor: rgb(0.3, 0.3, 0.3),
                        borderWidth: 0.7,
                    });
                    currentPage.drawText(wordSearchGrid[row][col], {
                        x: x + wsCellSize / 2 - font.widthOfTextAtSize(wordSearchGrid[row][col], wsCellSize * 0.6) / 2,
                        y: y + wsCellSize / 2 - (wsCellSize * 0.6) / 2 + 1,
                        font: font, size: wsCellSize * 0.6,
                        color: rgb(0, 0, 0),
                    });
                }
            }

            // Word Bank
            const wordBankStartX = wsGridStartX + wordSearchGridSize * wsCellSize + 20;
            let wordBankYOffset = wsGridStartY + wordSearchGridSize * wsCellSize - 10;

            currentPage.drawText('Word Bank:', {
                x: wordBankStartX,
                y: wordBankYOffset,
                font: boldFont,
                size: 14,
                color: rgb(0, 0, 0),
            });
            wordBankYOffset -= 20;

            const wordsPerColumn = Math.ceil(activeWordsForPuzzles.length / 2);
            for (let i = 0; i < activeWordsForPuzzles.length; i++) {
                const word = activeWordsForPuzzles[i];
                const col = Math.floor(i / wordsPerColumn);
                const x = wordBankStartX + (col * 100);
                const y = wordBankYOffset - (i % wordsPerColumn) * 15;

                currentPage.drawText(word, {
                    x: x, y: y, font: font, size: 10, color: rgb(0, 0, 0),
                });
            }

            // Save the PDF
            const pdfBytes = await pdfDoc.save();
            const blob = new Blob([pdfBytes], { type: 'application/pdf' });
            const url = URL.createObjectURL(blob);
            window.open(url, '_blank');
        }

        // Event Listeners
        wordInput.addEventListener('input', () => {
            if (!validateInput(wordInput.value)) {
                errorMessage.classList.remove('hidden');
                generatePuzzlesBtn.disabled = true;
            } else {
                errorMessage.classList.add('hidden');
                generatePuzzlesBtn.disabled = false;
            }
        });

        easyAnimalsBtn.addEventListener('click', () => {
            wordInput.value = themes.easyAnimals.join(', ');
            applyThemeStyling('easyAnimals');
            errorMessage.classList.add('hidden');
            generatePuzzlesBtn.disabled = false;
        });

        farmAnimalsBtn.addEventListener('click', () => {
            wordInput.value = themes.farmAnimals.join(', ');
            applyThemeStyling('farmAnimals');
            errorMessage.classList.add('hidden');
            generatePuzzlesBtn.disabled = false;
        });

        oceanAnimalsBtn.addEventListener('click', () => {
            wordInput.value = themes.oceanAnimals.join(', ');
            applyThemeStyling('oceanAnimals');
            errorMessage.classList.add('hidden');
            generatePuzzlesBtn.disabled = false;
        });

        resetBtn.addEventListener('click', resetApp);

        generatePuzzlesBtn.addEventListener('click', async () => {
            const rawWords = wordInput.value;
            if (!validateInput(rawWords)) {
                errorMessage.classList.remove('hidden');
                return;
            }
            errorMessage.classList.add('hidden');

            const words = rawWords.split(/[\n,]+/)
                                .map(word => word.trim().toUpperCase())
                                .filter(word => word.length > 0);

            if (words.length === 0) {
                alert('Please enter some words to generate puzzles.');
                return;
            }

            loadingOverlay.classList.remove('hidden');
            generatePuzzlesBtn.disabled = true;

            activeWordsForPuzzles = words;

            try {
                // Generate simple crossword
                generateSimpleCrossword(words);
                
                // Generate word search
                generateWordSearch();

                // Show puzzle section
                appContainer.classList.add('hidden');
                puzzlesSection.classList.remove('hidden');
            } catch (error) {
                console.error('Error generating puzzles:', error);
                alert('Failed to generate puzzles. Please try again. Error: ' + error.message);
            } finally {
                loadingOverlay.classList.add('hidden');
                generatePuzzlesBtn.disabled = false;
            }
        });

        printPdfBtn.addEventListener('click', async () => {
            loadingOverlay.classList.remove('hidden');
            printPdfBtn.disabled = true;
            try {
                await generatePdf();
            } catch (error) {
                console.error('Error printing PDF:', error);
                alert('Failed to print PDF. Please try again. Error: ' + error.message);
            } finally {
                loadingOverlay.classList.add('hidden');
                printPdfBtn.disabled = false;
            }
        });

        backToInputBtn.addEventListener('click', resetApp);

        // Initial check for generate button state
        wordInput.dispatchEvent(new Event('input'));
    </script>
</body>
</html>
